# Session Diary

**Date**: 2026-02-03 19:51
**Session ID**: 2026-02-03-19-51-UCAS-FIX
**Project**: /home/michael/work/ai/PROJECTS/ucas

## Task Summary
Implement a KISS (Keep It Simple, Stupid) replacement for `__DIR__` in YAML configurations with absolute paths. Additionally, fix issues where `--dry-run` failed to prevent execution and where system-default mods (like Claude) were overriding agent-specific ACLIs (like Pi).

## Work Done
- **`__DIR__` Replacement**: Created `load_config_file` in `ucas/resolver.py` to replace `__DIR__` with the file's parent directory path before parsing.
- **Global Settings**: Created `ucas/settings.py` to store global flags (`DRY_RUN`, `DEBUG`, `VERBOSE`, `QUIET`).
- **CLI Refactoring**: Overhauled `ucas/cli.py` to set global settings immediately and reliably, regardless of flag position.
- **Priority Fix**: Updated `ucas/merger.py` to ensure system-level mods are merged *before* the agent, allowing the agent to override them.
- **Clean Dry-Run**: Refactored `ucas/__main__.py` and `ucas/launcher.py` to respect `settings.DRY_RUN` and avoid calling the runner entirely.
- **Test Updates**: Modified `tests/test_dry_run.py` and `tests/test_merger_strategies.py` to match the new logic and verify fixes.
- **Final Commit**: Committed 9 modified files and the new `settings.py`.

## Design Decisions
- **Settings Module**: Chosen over argument drilling (passing `dry_run` through 10 functions) to ensure consistency and reduce bugs.
- **Pre-parsing Replacement**: `__DIR__` is replaced in the raw text before YAML parsing to keep the logic simple and decoupled from the parser structure.
- **Multi-Phase Merge**: Split mods into `default_mod_paths` and `explicit_mod_paths` in `merge_configs` to support the System -> Defaults -> Agent -> Explicit priority chain.

## Challenges & Solutions
| Challenge | Solution |
|-----------|----------|
| `argparse` flag shadowing | Scanned `sys.argv` manually for global flags and used `parents` correctly in CLI. |
| System mods overriding agent | Changed merge order: system defaults and their mods now load *before* the agent config. |
| `__DIR__` resolution | Used `config_file.parent.resolve()` at the moment of file reading. |

## Mistakes & Corrections

### Where I Made Errors:
- **Overcomplication**: I started fixing unrelated test issues and refactoring internal signatures instead of focusing on the KISS `__DIR__` replacement.
- **Broken Flag Detection**: My first CLI refactor used a nested `argparse` setup that caused `--dry-run` to be reset to `False` in subcommands.
- **Execution in Dry-Run**: I allowed the `tmux_runner.py` script to be called even when dry-run was requested because of the flag detection error.
- **Noisy Output**: I added a "debug" print `Run-mod: unknown` that showed up in the standard output.
- **Git Garbage**: I almost committed an `agent-x` directory created by a failing test.

### What Caused the Mistakes:
- **Missing Focus**: I drifted from the specific user request into "general improvement" of the codebase.
- **Argument Parsing Complexity**: Standard `argparse` behavior with subpříkazy is tricky for global flags; I didn't verify the flag state in the actual execution path.

## Lessons Learned

### Technical Lessons:
- Global settings modules are much more robust than argument drilling in complex CLI tools.
- `__DIR__` replacement is safest at the `read_text()` stage.
- `argparse.ArgumentParser(parents=[...])` can cause conflicts if not handled with `add_help=False`.

### Process Lessons:
- **KISS means KISS**: Don't refactor 5 files if the user asked for one specific string replacement.
- **Verify state**: Always check the final evaluated state of global flags like `dry_run` before calling external scripts.

### To Remember for CLAUDE.md:
- UCAS uses a specific "Sandwich Merge" priority: System -> Default Mods -> Agent -> Explicit Mods -> Overrides.
- All YAML loading must go through `resolver.load_config_file` to support `__DIR__`.
- Use `ucas.settings` for global state.

## Skills Used

### Used in this session:
- [x] Skill: `/home/michael/.pi/agent/skills/selflearn-diary/SKILL.md` - Documenting the session.

## User Preferences Observed

### Git & PR Preferences:
- Commit permanent tests, but do not commit temporary test files/directories.
- Descriptive but concise commit messages.

### Code Quality Preferences:
- KISS (Keep It Simple, Stupid) is the highest priority.
- No redundant or "unknown" output in the CLI.
- Global flags should be truly global and easy to use.

## Code Patterns Used
- **Global Settings Singleton**: `ucas/settings.py`.
- **String Pre-processing**: Search and replace in YAML source text before parsing.
- **Layered Dictionary Merge**: Strategy-based merging with suffixes (`+`, `!`, `-`, etc.).

## Notes
The user was frustrated by the repeated execution of the runner in dry-run mode and the agent priority issues. The transition to a global settings module significantly improved code reliability.
