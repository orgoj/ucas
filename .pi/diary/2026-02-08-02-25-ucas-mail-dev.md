# Session Diary

**Date**: 2026-02-08 02:25
**Session ID**: 2026-02-08-02-25-ucas-mail-dev
**Project**: /home/michael/work/ai/PROJECTS/ucas

## Task Summary
Implement a KISS file-based mailing system for UCAS agents. The goal is to enable reliable communication between agents and the user. The system includes CLI commands, a Tkinter GUI, and an AI skill.

## Work Done
- **Infrastructure**:
    - `ucas/mail.py`: File storage, JSON default output for CLI, cross-project addressing via absolute paths in `from_project`.
    - `ucas/cli.py`: Subcommands for `mail` (`send`, `list`, `read`, `check`, `addressbook`, `gui`).
    - Improved `run-team`/`stop-team` merging logic to correctly include the team mod.
- **GUI**:
    - `ucas/mail_gui.py`: Basic Tkinter app. Added fix to clear message body when switching folders.
- **Agent Integration**:
    - Created `using-ucas-mail` skill with YAML frontmatter and clear workflow rules.
    - Updated `.dippy` to enforce CLI usage and forbid direct file access to mail directories.
- **Runner**:
    - Fixed `run-tmux` to support stopping sessions via `tmux_stop.py`.

## Design Decisions
- **JSON by Default**: All CLI outputs (`list`, `read`, `addressbook`) now default to JSON for easier AI parsing.
- **Absolute Routing**: Mail metadata now includes `from_project` as an absolute path to ensure `--reply` works across any project directory.
- **Explicit Body Flag**: Added `--body` to `mail send` to avoid STDIN redirection issues with AI agents.

## Challenges & Solutions
| Challenge | Solution |
|-----------|----------|
| Cross-project communication | Added `from_project` to JSON and updated routing logic in `mail.py`. |
| `stop-team` non-functional | Implemented `stop_script` in `run-tmux` mod. |
| Agents ignoring CLI | Used Dippy permissions to block file reads and redirect to `ucas mail read`. |

## Mistakes & Corrections
### Where I Made Errors:
- **Premature Completion**: Claimed the system was "perfect" when agents are still showing inconsistent behavior.
- **Address Book Pollution**: The `addressbook` command picks up non-agent directories like `stop` or `generic` if they exist in `notes/`.
- **Agent Hallucinations**: Alice sometimes thinks she sent a report when she only thought about it.
- **Relative Paths**: Initially used relative paths for projects, which proved unreliable.

### What Caused the Mistakes:
- **Testing limitations**: Testing in a terminal without an X server makes GUI verification manual/slow.
- **Heuristic failure**: Assuming `ls` output without `-a` was representative of project config.

## Lessons Learned
### Technical Lessons:
- **Full Paths Matter**: In a multi-agent system spanning multiple directories, relative paths are a liability. Always use `Path.resolve()`.
- **JSON is the Universal Language**: For agent-to-agent or agent-to-tool communication, structured JSON beats formatted tables every time.

### Process Lessons:
- **Don't Rush the "Done"**: Just because the code runs doesn't mean the *system* (code + agents) works as intended.
- **Dippy is a Hard Guardrail**: Use filesystem permissions to force agents out of bad habits (like reading internal data files).

## To Remember for CLAUDE.md:
- Documentation of `ucas mail` usage.
- Guidance on not reading `.ucas/notes/*/mail/` files directly.

## Skills Used
- `creating-skills`: For the `using-ucas-mail` skill.
- `tmux-automation`: For debugging the `alpha-squad` team.
- `brainstorming`: For the initial design.

## Feedback for Skills:
| File | Issue/Observation | Suggested Fix/Action |
|------|-------------------|----------------------|
| `mods/ucas-mail/skills/using-ucas-mail/SKILL.md` | Timeout issues with `check --idle` | Added instruction to use high timeouts (300s+). |

## User Preferences Observed
- **KISS Standard**: No external dependencies (Python stdlib only).
- **Explicit over Implicit**: Use absolute paths for routing.
- **AI-Native CLI**: JSON defaults for all data-returning commands.

## Notes
**STATUS: IN PROGRESS / BUGGY.**
Remaining issues to fix tomorrow:
1. Alice's reliability in actually executing `send` commands.
2. Filter the `addressbook` to only show real agents.
3. Final verification of the full team loop.
